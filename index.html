<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="theme-color" content="#0a0e17"/>
<title>SignalScope</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0a0e17;--bg2:#111827;--cd:#151d2e;--cdh:#1a2438;--bd:#1e293b;--bd2:#334155;--t1:#f1f5f9;--t2:#94a3b8;--t3:#64748b;--gn:#10b981;--gg:rgba(16,185,129,.12);--rd:#ef4444;--rg:rgba(239,68,68,.12);--am:#f59e0b;--bl:#3b82f6;--pu:#8b5cf6;--cy:#06b6d4;--or:#f97316;--tl:#14b8a6;--pk:#ec4899}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:2px}
.hdr{position:sticky;top:0;z-index:100;background:rgba(10,14,23,.88);backdrop-filter:blur(20px);border-bottom:1px solid var(--bd);padding:0 16px}
.hi{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:52px}
.logo{display:flex;align-items:center;gap:8px}.lic{width:28px;height:28px;background:linear-gradient(135deg,var(--gn),var(--cy));border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:var(--bg)}.lt{font-size:15px;font-weight:700}
.hr{display:flex;align-items:center;gap:6px}
.bdg{display:flex;align-items:center;gap:4px;padding:4px 9px;background:var(--cd);border:1px solid var(--bd);border-radius:14px;font-size:10px;color:var(--t2);font-family:'JetBrains Mono',monospace}
.dot{width:6px;height:6px;border-radius:50%}.dot.on{background:var(--gn);animation:p1 2s infinite}.dot.off{background:var(--rd)}.dot.w{background:var(--am);animation:p2 2s infinite}
@keyframes p1{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.5)}50%{box-shadow:0 0 0 5px rgba(16,185,129,0)}}
@keyframes p2{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,.5)}50%{box-shadow:0 0 0 5px rgba(245,158,11,0)}}
.btn{padding:6px 12px;border:1px solid var(--bd);border-radius:7px;background:var(--cd);color:var(--t1);font-size:11px;font-weight:600;cursor:pointer;transition:.1s}.btn:active{transform:scale(.97)}
.btn-g{background:linear-gradient(135deg,var(--gn),#059669);border:none;color:#fff}.btn-g:disabled{opacity:.5}
.btn-sm{padding:4px 8px;font-size:10px;border-radius:5px}
.btn-r{background:var(--rg);color:var(--rd);border:1px solid rgba(239,68,68,.2)}
.btn-pu{background:rgba(139,92,246,.12);color:var(--pu);border:1px solid rgba(139,92,246,.2)}
.mn{max-width:1400px;margin:0 auto;padding:14px}
.sts{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
.st{background:var(--cd);border:1px solid var(--bd);border-radius:9px;padding:10px}
.stl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);margin-bottom:3px}
.stv{font-size:20px;font-weight:800;font-family:'JetBrains Mono',monospace;letter-spacing:-1px}
.sts2{font-size:9px;color:var(--t3);font-family:'JetBrains Mono',monospace}
/* Index pill row */
.idx-row{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap;padding-bottom:6px}
.idx-btn{padding:5px 11px;border-radius:18px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid var(--bd);background:var(--cd);color:var(--t3);display:flex;align-items:center;gap:4px;transition:.15s;white-space:nowrap}
.idx-btn:hover{border-color:var(--bd2);color:var(--t2)}
.idx-btn.a{color:#fff}
.idx-btn.a[data-idx="all"]{background:var(--bl);border-color:var(--bl)}
.idx-btn.a[data-idx="NIFTY 50"]{background:#7c3aed;border-color:#7c3aed}
.idx-btn.a[data-idx="NIFTY 100"]{background:var(--cy);border-color:var(--cy)}
.idx-btn.a[data-idx="NIFTY 200"]{background:var(--tl);border-color:var(--tl)}
.idx-btn.a[data-idx="BSE 100"]{background:var(--or);border-color:var(--or)}
.idx-btn.a[data-idx="MIDCAP 150"]{background:var(--pk);border-color:var(--pk)}
.idx-btn.a[data-idx="OTHER NSE"]{background:var(--t3);border-color:var(--t3)}
.idx-cnt{font-family:'JetBrains Mono',monospace;font-size:9px;opacity:.8}
/* Signal tabs */
.tabs{display:flex;gap:2px;background:var(--bg2);padding:3px;border-radius:9px;margin-bottom:12px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{padding:7px 12px;border-radius:6px;font-size:11px;font-weight:600;color:var(--t3);cursor:pointer;border:none;background:transparent;white-space:nowrap;display:flex;align-items:center;gap:5px;flex-shrink:0}
.tab.a{background:var(--cd);color:var(--t1);box-shadow:0 2px 6px rgba(0,0,0,.2)}
.tc{padding:1px 5px;border-radius:7px;font-size:9px;font-family:'JetBrains Mono',monospace;font-weight:700}
.tcg{background:var(--gg);color:var(--gn)}.tcr{background:var(--rg);color:var(--rd)}.tcb{background:rgba(59,130,246,.12);color:var(--bl)}.tcp{background:rgba(139,92,246,.12);color:var(--pu)}
.srch{position:relative;margin-bottom:12px}.srch input{width:100%;padding:9px 12px 9px 34px;background:var(--cd);border:1px solid var(--bd);border-radius:9px;color:var(--t1);font-size:13px;outline:none}.srch input:focus{border-color:var(--bl)}.srch input::placeholder{color:var(--t3)}.srch::before{content:'‚åï';position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--t3);font-size:14px}
.tc2{background:var(--cd);border:1px solid var(--bd);border-radius:11px;overflow:hidden}.ts{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;font-size:11px}thead{position:sticky;top:0;z-index:5}
th{padding:9px 10px;text-align:left;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);background:var(--bg2);border-bottom:1px solid var(--bd);white-space:nowrap;cursor:pointer}
td{padding:10px;border-bottom:1px solid rgba(30,41,59,.3);white-space:nowrap;font-family:'JetBrains Mono',monospace;font-size:11px}
tr{transition:background .1s}tr:active{background:var(--cdh)}
.sn{font-family:'DM Sans',sans-serif}.sns{font-weight:700;font-size:12px;color:var(--t1)}.snn{font-size:9px;color:var(--t3)}
.pb{display:inline-block;padding:1px 5px;border-radius:3px;font-size:8px;font-weight:700;background:rgba(139,92,246,.12);color:var(--pu);margin-left:4px}
.itag{display:inline-block;padding:1px 4px;border-radius:3px;font-size:7px;font-weight:700;margin-left:3px}
.itag-n50{background:rgba(124,58,237,.15);color:#a78bfa}
.itag-n100{background:rgba(6,182,212,.15);color:var(--cy)}
.itag-n200{background:rgba(20,184,166,.15);color:#2dd4bf}
.itag-bse{background:rgba(249,115,22,.15);color:var(--or)}
.itag-mid{background:rgba(236,72,153,.15);color:#f472b6}
.itag-other{background:rgba(100,116,139,.12);color:var(--t3)}
.score{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:800;font-family:'JetBrains Mono',monospace;cursor:pointer;display:inline-block;min-width:40px;text-align:center}
.score-buy{background:var(--gg);color:var(--gn);border:1px solid rgba(16,185,129,.25)}.score-buy.strong{background:rgba(16,185,129,.2);box-shadow:0 0 8px rgba(16,185,129,.15)}
.score-sell{background:var(--rg);color:var(--rd);border:1px solid rgba(239,68,68,.25)}
.ds{display:flex;gap:3px}.d{width:6px;height:6px;border-radius:50%;flex-shrink:0}.d.p{background:var(--rd);box-shadow:0 0 4px rgba(239,68,68,.4)}.d.f{background:var(--t3);opacity:.2}
.rr{font-size:10px;font-weight:600}.rr-good{color:var(--gn)}.rr-ok{color:var(--am)}.rr-bad{color:var(--rd)}
.macd-slope{font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:3px}
.slope-up{color:var(--gn)}.slope-dn{color:var(--rd)}.slope-flat{color:var(--t3)}
.sig{padding:3px 8px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:.3px}
.sig-b{background:var(--gg);color:var(--gn);border:1px solid rgba(16,185,129,.2)}.sig-mb{background:rgba(6,182,212,.1);color:var(--cy);border:1px solid rgba(6,182,212,.2)}.sig-s{background:var(--rg);color:var(--rd);border:1px solid rgba(239,68,68,.2)}.sig-h{background:rgba(100,116,139,.06);color:var(--t3);border:1px solid rgba(100,116,139,.1)}
/* Modal */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:200;display:flex;align-items:flex-end;justify-content:center;animation:fi .15s}
@media(min-width:768px){.mo{align-items:center;padding:24px}}@keyframes fi{from{opacity:0}to{opacity:1}}
.moc{background:var(--cd);border:1px solid var(--bd2);border-radius:14px 14px 0 0;width:100%;max-height:88dvh;overflow-y:auto;animation:su .2s ease}
@media(min-width:768px){.moc{max-width:680px;border-radius:14px;max-height:85vh}}@keyframes su{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.moh{padding:16px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:flex-start;position:sticky;top:0;background:var(--cd);z-index:1}
.mox{width:26px;height:26px;border-radius:6px;border:1px solid var(--bd);background:transparent;color:var(--t3);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.mob{padding:16px}
.ig{display:grid;grid-template-columns:1fr 1fr;gap:8px}@media(max-width:480px){.ig{grid-template-columns:1fr}}
.ic{background:var(--bg2);border:1px solid var(--bd);border-radius:7px;padding:10px}
.ich{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.ict{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:var(--t2)}
.ics{font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px}.ics.p{background:var(--gg);color:var(--gn)}.ics.f{background:var(--rg);color:var(--rd)}
.icv{font-size:16px;font-weight:700;font-family:'JetBrains Mono',monospace}.icd{font-size:9px;color:var(--t3);margin-top:3px}
.sbar{width:100%;height:8px;background:rgba(255,255,255,.05);border-radius:4px;overflow:hidden;margin-top:4px}.sbar-f{height:100%;border-radius:4px;transition:width .3s}
.sr-row{display:flex;gap:10px;margin-top:12px;padding:12px;background:var(--bg2);border:1px solid var(--bd);border-radius:8px}.sr-item{flex:1;text-align:center}.sr-label{font-size:9px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.4px}.sr-val{font-size:16px;font-weight:800;font-family:'JetBrains Mono',monospace;margin-top:2px}
/* Watchlist */
.wl-bar{display:flex;gap:6px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.wl-chip{padding:5px 12px;border-radius:16px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid rgba(139,92,246,.3);background:rgba(139,92,246,.08);color:var(--pu);display:flex;align-items:center;gap:5px}
.wl-chip.a{background:var(--pu);color:#fff;border-color:var(--pu)}
.wl-chip .x{font-size:13px;opacity:.6;cursor:pointer;margin-left:2px}.wl-chip .x:hover{opacity:1}
.wl-add-btn{padding:5px 10px;border-radius:16px;font-size:11px;font-weight:600;cursor:pointer;border:1px dashed var(--bd2);background:transparent;color:var(--t3)}
.wl-input{padding:5px 10px;border-radius:16px;font-size:11px;border:1px solid var(--pu);background:var(--bg2);color:var(--t1);outline:none;width:120px}
/* Scan progress */
.scan-bar{background:var(--cd);border:1px solid var(--bd);border-radius:9px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:10px}
.scan-prog{flex:1;height:6px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden}.scan-fill{height:100%;background:var(--gn);border-radius:3px;transition:width .5s}
.scan-txt{font-size:10px;color:var(--t2);font-family:'JetBrains Mono',monospace;white-space:nowrap}
/* Setup */
.setup{text-align:center;padding:50px 20px;max-width:460px;margin:0 auto}.setup h2{font-size:18px;margin:12px 0 8px}.setup p{color:var(--t2);font-size:13px;line-height:1.6;margin-bottom:14px}.setup code{display:block;background:var(--bg2);border:1px solid var(--bd);border-radius:7px;padding:10px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--gn);text-align:left;margin:10px 0;white-space:pre;overflow-x:auto}
.miss{display:inline-block;padding:2px 8px;border-radius:4px;background:var(--rg);color:var(--rd);font-size:11px;font-weight:600;margin:2px}
.ld{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 0;color:var(--t3)}
.sp{width:28px;height:28px;border:3px solid var(--bd);border-top-color:var(--gn);border-radius:50%;animation:spn .7s linear infinite;margin-bottom:10px}@keyframes spn{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px 16px;color:var(--t3)}
@media(max-width:600px){.sts{grid-template-columns:repeat(2,1fr)}.stv{font-size:17px}.mn{padding:10px}}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const {useState,useEffect,useCallback,useMemo,useRef}=React;
const API=window.location.origin;
const fmt=(n,d=2)=>n!=null?Number(n).toFixed(d):'‚Äî';
const ago=(iso)=>{if(!iso)return'Never';const d=(Date.now()-new Date(iso).getTime())/1e3;if(d<60)return`${Math.floor(d)}s`;if(d<3600)return`${Math.floor(d/60)}m`;return`${Math.floor(d/3600)}h`};
const ITAG_CLS={"NIFTY 50":"itag-n50","NIFTY 100":"itag-n100","NIFTY 200":"itag-n200","BSE 100":"itag-bse","MIDCAP 150":"itag-mid","OTHER NSE":"itag-other"};

const IDX_TABS=[
  {k:'all',l:'All NSE'},
  {k:'NIFTY 50',l:'NIFTY 50'},
  {k:'NIFTY 100',l:'NIFTY 100'},
  {k:'NIFTY 200',l:'NIFTY 200'},
  {k:'BSE 100',l:'BSE 100'},
  {k:'MIDCAP 150',l:'Midcap 150'},
  {k:'OTHER NSE',l:'Other NSE'},
];

function loadWL(){try{return JSON.parse(localStorage.getItem('ss_watchlists'))||{}}catch(e){return{}}}
function saveWL(w){localStorage.setItem('ss_watchlists',JSON.stringify(w))}

function ITags({indices}){if(!indices||!indices.length)return null;return<>{indices.map(i=><span key={i}className={`itag ${ITAG_CLS[i]||'itag-other'}`}>{i}</span>)}</>}
function SellDots({c}){return<div className="ds">{Object.keys(c).map(k=><div key={k}className={`d ${c[k]?'p':'f'}`}title={k}/>)}</div>}
function RR({ratio}){if(!ratio||ratio<=0)return<span className="rr rr-bad">‚Äî</span>;const cl=ratio>=2?'rr-good':ratio>=1?'rr-ok':'rr-bad';return<span className={`rr ${cl}`}>{ratio.toFixed(1)}:1</span>}
function MACDSlope({slope,phase,curve}){
  if(slope==null)return<span className="macd-slope slope-flat">‚Äî</span>;
  const phaseColors={"BUY FLIP":"var(--gn)","EARLY BUY":"#34d399","SELL FLIP":"var(--rd)","EARLY SELL":"#f87171","BULLISH":"var(--gn)","BEARISH":"var(--rd)","NEUTRAL":"var(--t3)"};
  const col=phaseColors[phase]||"var(--t3)";
  let pathD='';
  if(curve&&curve.length>2){
    const w=48,h=18;
    const pts=curve.map((v,i)=>`${(i/(curve.length-1))*w},${h-v*h}`);
    pathD=`M${pts.join(' L')}`;
  }
  return<div style={{display:'flex',alignItems:'center',gap:'4px'}}>
    {pathD&&<svg width="48"height="18"viewBox="0 0 48 18"style={{flexShrink:0}}>
      <line x1="0"y1="9"x2="48"y2="9"stroke="var(--bd2)"strokeWidth="0.5"strokeDasharray="2,2"/>
      <path d={pathD}fill="none"stroke={col}strokeWidth="1.5"strokeLinecap="round"strokeLinejoin="round"/>
      <circle cx={48}cy={18-(curve[curve.length-1]||0)*18}r="2"fill={col}/>
    </svg>}
    <div style={{display:'flex',flexDirection:'column',gap:'0px'}}>
      {phase&&<span style={{fontSize:'7px',fontWeight:700,color:col,letterSpacing:'.3px',lineHeight:'1.2'}}>{phase}</span>}
      <span style={{fontSize:'9px',fontFamily:"'JetBrains Mono'",color:col}}>{slope>0?'+':''}{slope.toFixed(2)}</span>
    </div>
  </div>
}

function Modal({s,onClose,watchlists,onAddToWL}){
  if(!s)return null;
  const bb=s.buy_breakdown||{};const sc=s.sell_conditions||{};
  const indicators=["sma200","macd_inflection","rsi","bollinger","adx","obv"];
  const sellI=[{k:'trend_break',t:'Trend Break',d:'Close < SMA200'},{k:'momentum_reversal',t:'RSI ‚â• 65',d:'Overbought'},{k:'volatility_extreme',t:'Upper BB',d:'Stretched'},{k:'momentum_fade',t:'MACD Fade',d:'Bearish cross'},{k:'volume_weakness',t:'OBV Drop',d:'Volume leaving'},{k:'macd_slope_flip',t:'MACD Slope ‚Üì',d:'Slope flipped negative'}];
  const wlNames=Object.keys(watchlists);
  return<div className="mo"onClick={onClose}><div className="moc"onClick={e=>e.stopPropagation()}>
    <div className="moh"><div>
      <div style={{display:'flex',alignItems:'center',gap:'6px',flexWrap:'wrap'}}>
        <span style={{fontSize:'17px',fontWeight:800}}>{s.name}</span>
        <span style={{fontSize:'11px',color:'var(--t3)',fontFamily:"'JetBrains Mono'"}}>{s.symbol}</span>
        {s.in_portfolio&&<span className="pb">HELD</span>}
      </div>
      <div style={{marginTop:'2px'}}><ITags indices={s.indices}/></div>
      <div style={{marginTop:'4px',fontSize:'22px',fontWeight:800,fontFamily:"'JetBrains Mono'"}}>‚Çπ{fmt(s.price)}</div>
      {wlNames.length>0&&<div style={{marginTop:'6px',display:'flex',gap:'4px',flexWrap:'wrap'}}>
        {wlNames.map(wn=>{const inIt=watchlists[wn]?.includes(s.symbol);
          return<button key={wn}className={`btn btn-sm ${inIt?'btn-r':'btn-pu'}`}onClick={e=>{e.stopPropagation();onAddToWL(wn,s.symbol,!inIt)}}>{inIt?`‚úï ${wn}`:`+ ${wn}`}</button>
        })}
      </div>}
    </div><button className="mox"onClick={onClose}>‚úï</button></div>
    <div className="mob">
      <div style={{display:'flex',gap:'10px',marginBottom:'16px'}}>
        <div style={{flex:1,padding:'14px',background:'var(--gg)',borderRadius:'8px',textAlign:'center'}}>
          <div style={{fontSize:'9px',fontWeight:700,color:'var(--gn)',letterSpacing:'.5px'}}>BUY SCORE</div>
          <div style={{fontSize:'36px',fontWeight:800,fontFamily:"'JetBrains Mono'",color:'var(--gn)'}}>{s.buy_score}</div>
          <div style={{fontSize:'10px',color:'var(--gn)',fontWeight:600}}>{s.buy_signal}</div>
        </div>
        <div style={{flex:1,padding:'14px',background:'var(--rg)',borderRadius:'8px',textAlign:'center'}}>
          <div style={{fontSize:'9px',fontWeight:700,color:'var(--rd)',letterSpacing:'.5px'}}>SELL</div>
          <div style={{fontSize:'36px',fontWeight:800,fontFamily:"'JetBrains Mono'",color:'var(--rd)'}}>{s.sell_count}</div>
          <SellDots c={sc}/>
        </div>
      </div>
      <div className="sr-row">
        <div className="sr-item"><div className="sr-label">Support</div><div className="sr-val"style={{color:'var(--gn)'}}>‚Çπ{fmt(s.support)}</div></div>
        <div className="sr-item"><div className="sr-label">Resistance</div><div className="sr-val"style={{color:'var(--rd)'}}>‚Çπ{fmt(s.resistance)}</div></div>
        <div className="sr-item"><div className="sr-label">R:R</div><div className="sr-val"><RR ratio={s.rr_ratio}/></div></div>
      </div>
      {/* MACD Momentum Phase */}
      {(()=>{
        const phC={"BUY FLIP":"var(--gn)","EARLY BUY":"#34d399","SELL FLIP":"var(--rd)","EARLY SELL":"#f87171","BULLISH":"var(--gn)","BEARISH":"var(--rd)","NEUTRAL":"var(--t3)"};
        const pc=phC[s.macd_phase]||"var(--t3)";
        return<div style={{marginTop:'12px',padding:'12px',background:'var(--bg2)',border:'1px solid var(--bd)',borderRadius:'8px'}}>
          <div style={{fontSize:'9px',fontWeight:700,color:'var(--t3)',letterSpacing:'.5px',marginBottom:'6px'}}>MACD MOMENTUM ANALYSIS</div>
          {(()=>{
            const cv=s.macd_curve||[];
            if(cv.length<3)return null;
            const w=260,h=50;
            const pts=cv.map((v,i)=>`${(i/(cv.length-1))*w},${h-v*h}`);
            const pathD=`M${pts.join(' L')}`;
            // Zero line position (find where normalised value maps to 0)
            return<svg width="100%"height="50"viewBox={`0 0 ${w} ${h}`}preserveAspectRatio="none"style={{marginBottom:'8px',borderRadius:'4px',background:'rgba(0,0,0,.2)'}}>
              <line x1="0"y1={h/2}x2={w}y2={h/2}stroke="var(--bd2)"strokeWidth="0.5"strokeDasharray="3,3"/>
              <path d={pathD}fill="none"stroke={pc}strokeWidth="2"strokeLinecap="round"strokeLinejoin="round"/>
              <circle cx={w}cy={h-(cv[cv.length-1]||0)*h}r="3"fill={pc}/>
            </svg>
          })()}
          <div style={{display:'flex',gap:'12px',alignItems:'center',flexWrap:'wrap'}}>
            <div style={{padding:'6px 14px',background:pc+'18',borderRadius:'6px',border:`1px solid ${pc}40`}}>
              <div style={{fontSize:'14px',fontWeight:800,color:pc}}>{s.macd_phase||'‚Äî'}</div>
            </div>
            <div><div style={{fontSize:'8px',color:'var(--t3)'}}>d(MACD)/dt</div><div style={{fontSize:'14px',fontWeight:700,fontFamily:"'JetBrains Mono'",color:s.macd_slope>0?'var(--gn)':s.macd_slope<0?'var(--rd)':'var(--t3)'}}>{s.macd_slope!=null?(s.macd_slope>0?'+':'')+s.macd_slope.toFixed(4):'‚Äî'}</div></div>
            <div><div style={{fontSize:'8px',color:'var(--t3)'}}>d¬≤(MACD)/dt¬≤</div><div style={{fontSize:'14px',fontWeight:700,fontFamily:"'JetBrains Mono'",color:s.macd_accel>0?'var(--gn)':s.macd_accel<0?'var(--rd)':'var(--t3)'}}>{s.macd_accel!=null?(s.macd_accel>0?'+':'')+s.macd_accel.toFixed(4):'‚Äî'}</div></div>
          </div>
          <div style={{fontSize:'8px',color:'var(--t3)',marginTop:'6px',lineHeight:'1.4'}}>
            {s.macd_phase==='BUY FLIP'&&'Slope just crossed zero upward ‚Äî momentum confirmed bullish'}
            {s.macd_phase==='EARLY BUY'&&'Decline decelerating (d¬≤>0 while d<0) ‚Äî potential bottom forming'}
            {s.macd_phase==='SELL FLIP'&&'Slope just crossed zero downward ‚Äî momentum confirmed bearish'}
            {s.macd_phase==='EARLY SELL'&&'Rise decelerating (d¬≤<0 while d>0) ‚Äî potential top forming'}
            {s.macd_phase==='BULLISH'&&'Rising momentum with positive acceleration ‚Äî strong uptrend'}
            {s.macd_phase==='BEARISH'&&'Falling momentum with negative acceleration ‚Äî strong downtrend'}
          </div>
        </div>
      })()}
      <h3 style={{fontSize:'11px',fontWeight:700,color:'var(--gn)',margin:'16px 0 8px'}}>BUY INDICATORS</h3>
      <div className="ig"style={{marginBottom:'16px'}}>{indicators.map(k=>{const b=bb[k];if(!b)return null;const pct=b.max>0?(b.pts/b.max*100):0;
        return<div className="ic"key={k}><div className="ich"><span className="ict">{k.toUpperCase()}</span><span className={`ics ${b.pass?'p':'f'}`}>{b.pts}/{b.max}</span></div><div className="icv">{b.val!=null?b.val:'‚Äî'}</div><div className="sbar"><div className="sbar-f"style={{width:`${pct}%`,background:b.pass?'var(--gn)':'var(--rd)'}}/></div><div className="icd">{b.desc}</div></div>
      })}</div>
      <h3 style={{fontSize:'11px',fontWeight:700,color:'var(--rd)',marginBottom:'8px'}}>SELL INDICATORS</h3>
      <div className="ig">{sellI.map(i=><div className="ic"key={i.k}><div className="ich"><span className="ict">{i.t}</span><span className={`ics ${sc[i.k]?'p':'f'}`}>{sc[i.k]?'‚úì':'‚úó'}</span></div><div className="icd">{i.d}</div></div>)}</div>
    </div>
  </div></div>
}

function App(){
  const[data,setData]=useState(null);const[status,setStatus]=useState(null);const[loading,setLoading]=useState(true);
  const[progress,setProgress]=useState(null);
  const[idxFilter,setIdxFilter]=useState('all');
  const[tab,setTab]=useState('all');const[search,setSearch]=useState('');const[sortK,setSortK]=useState('buy_score');const[sortA,setSortA]=useState(false);const[sel,setSel]=useState(null);
  const[watchlists,setWatchlists]=useState(loadWL);
  const[activeWL,setActiveWL]=useState(null);
  const[addingWL,setAddingWL]=useState(false);
  const[newWLName,setNewWLName]=useState('');
  const inputRef=useRef(null);

  const setAndSaveWL=(w)=>{setWatchlists(w);saveWL(w)};
  const createWL=(name)=>{if(!name.trim())return;const w={...watchlists,[name.trim()]:[]};setAndSaveWL(w);setAddingWL(false);setNewWLName('')};
  const deleteWL=(name)=>{const w={...watchlists};delete w[name];setAndSaveWL(w);if(activeWL===name){setActiveWL(null);setIdxFilter('all')}};
  const toggleInWL=(wlName,symbol,add)=>{const w={...watchlists};if(!w[wlName])w[wlName]=[];if(add&&!w[wlName].includes(symbol))w[wlName].push(symbol);if(!add)w[wlName]=w[wlName].filter(s=>s!==symbol);setAndSaveWL(w)};

  useEffect(()=>{if(addingWL&&inputRef.current)inputRef.current.focus()},[addingWL]);

  const fetchAll=useCallback(async()=>{try{const[r1,r2,r3]=await Promise.all([fetch(`${API}/api/results`),fetch(`${API}/api/status`),fetch(`${API}/api/progress`)]);setData(await r1.json());setStatus(await r2.json());setProgress(await r3.json())}catch(e){}finally{setLoading(false)}},[]);
  useEffect(()=>{fetchAll();const t=setInterval(fetchAll,isSc?5000:15000);return()=>clearInterval(t)},[fetchAll,isSc]);
  const[scanError,setScanError]=useState(null);

  const triggerScan=async()=>{
    setScanError(null);
    try{
      const r=await fetch(`${API}/api/scan`,{method:'POST'});
      const j=await r.json();
      if(!r.ok){setScanError(j.error||'Scan failed');return}
      fetchAll();
    }catch(e){setScanError('Network error')}
  };
  const reconnect=async()=>{
    setScanError(null);
    try{
      const r=await fetch(`${API}/api/reconnect`,{method:'POST'});
      const j=await r.json();
      if(!r.ok){setScanError(j.error||'Reconnect failed');return}
      setScanError(null);
      fetchAll();
    }catch(e){setScanError('Network error')}
  };
  const toggleScanMode=async()=>{
    const newMode=status?.scan_mode==='top500'?'full':'top500';
    try{await fetch(`${API}/api/scan_mode`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:newMode})});fetchAll()}catch(e){}
  };
  const doSort=(k)=>{if(sortK===k)setSortA(!sortA);else{setSortK(k);setSortA(false)}};

  const stocks=useMemo(()=>{
    if(!data)return[];
    let l=tab==='buy'?data.buy_signals||[]:tab==='sell'?data.sell_signals||[]:tab==='port'?(data.all_stocks||[]).filter(s=>s.in_portfolio):data.all_stocks||[];
    if(idxFilter==='watchlist'&&activeWL){
      const syms=watchlists[activeWL]||[];
      l=(data.all_stocks||[]).filter(s=>syms.includes(s.symbol));
    }else if(idxFilter!=='all'){
      l=l.filter(s=>s.indices&&s.indices.includes(idxFilter));
    }
    if(search){const q=search.toLowerCase();l=l.filter(s=>s.symbol.toLowerCase().includes(q)||s.name.toLowerCase().includes(q))}
    return[...l].sort((a,b)=>{const va=a[sortK],vb=b[sortK];if(va==null)return 1;if(vb==null)return-1;return sortA?(va>vb?1:-1):(va<vb?1:-1)})
  },[data,idxFilter,activeWL,watchlists,tab,search,sortK,sortA]);

  const filteredCounts=useMemo(()=>{
    if(!data)return{all:0,buy:0,sell:0,port:0};
    const f=s=>{
      if(idxFilter==='watchlist'&&activeWL)return(watchlists[activeWL]||[]).includes(s.symbol);
      if(idxFilter!=='all')return s.indices&&s.indices.includes(idxFilter);
      return true;
    };
    return{all:(data.all_stocks||[]).filter(f).length,buy:(data.buy_signals||[]).filter(f).length,sell:(data.sell_signals||[]).filter(f).length,port:(data.all_stocks||[]).filter(s=>s.in_portfolio&&f(s)).length}
  },[data,idxFilter,activeWL,watchlists]);

  if(loading)return<div className="ld"><div className="sp"/>Connecting...</div>;
  if(status&&!status.connected&&status.missing?.length>0){
    return<><header className="hdr"><div className="hi"><div className="logo"><div className="lic">S</div><div className="lt">SignalScope</div></div><div className="bdg"><div className="dot off"/>OFFLINE</div></div></header><main className="mn"><div className="setup"><div style={{fontSize:'40px'}}>üîê</div><h2>Credentials Required</h2><div>{status.missing.map(m=><span key={m}className="miss">{m}</span>)}</div><code>{`ANGEL_API_KEY=your_key\nANGEL_CLIENT_ID=your_id\nANGEL_PASSWORD=your_pin\nANGEL_TOTP_TOKEN=your_totp`}</code></div></main></>;
  }

  const nT=data?.total_scanned||0;
  const isSc=data?.status==='scanning'||status?.is_scanning;
  const instCount=status?.instruments_scan||status?.instruments||0;
  const curMode=status?.scan_mode||'top500';

  if(!data||!data.last_scan||nT===0){
    const isConn=status?.connected;
    return<><header className="hdr"><div className="hi"><div className="logo"><div className="lic">S</div><div className="lt">SignalScope</div></div><div className="hr">
      <div className="bdg"><div className={`dot ${isSc?'w':isConn?'on':'off'}`}/>{isSc?'SCANNING':isConn?'READY':'OFFLINE'}</div>
      {!isSc&&isConn&&<button className="btn btn-g"onClick={triggerScan}>‚ñ∂ Scan</button>}
      {!isConn&&<button className="btn"onClick={reconnect}style={{background:'var(--am)',border:'none',color:'#000'}}>üîå Reconnect</button>}
    </div></div></header>
    <main className="mn"><div className="setup">
      <div style={{fontSize:'40px'}}>{isSc?'‚è≥':isConn?'üìä':'üîå'}</div>
      <h2>{isSc?'Scanning...':isConn?'Ready to scan':'Connection failed'}</h2>
      {!isConn&&!isSc&&<p style={{color:'var(--rd)'}}>Could not connect to Angel One. This usually happens if the API timed out or you were rate-limited. Click Reconnect to try again.</p>}
      {isConn&&!isSc&&<p>Choose scan mode, then tap Scan.</p>}
      {scanError&&<div style={{margin:'8px auto',padding:'8px 14px',background:'var(--rg)',borderRadius:'6px',fontSize:'11px',color:'var(--rd)',fontWeight:600,maxWidth:'380px'}}>{scanError}</div>}
      {!isSc&&isConn&&<div style={{display:'flex',gap:'8px',justifyContent:'center',marginBottom:'16px'}}>
        <button className={`btn ${curMode==='top500'?'btn-g':''}`}onClick={()=>{if(curMode!=='top500')toggleScanMode()}} style={{minWidth:'110px'}}>Top 500 <span style={{fontSize:'9px',opacity:.7}}>~5min</span></button>
        <button className={`btn ${curMode==='full'?'btn-g':''}`}onClick={()=>{if(curMode!=='full')toggleScanMode()}} style={{minWidth:'110px'}}>All NSE <span style={{fontSize:'9px',opacity:.7}}>~15min</span></button>
      </div>}
      {!isConn&&!isSc&&<div style={{marginTop:'12px'}}><button className="btn"onClick={reconnect}style={{background:'var(--am)',border:'none',color:'#000',padding:'10px 24px',fontSize:'13px'}}>üîå Reconnect to Angel One</button></div>}
      {isSc&&(()=>{
        const p=progress||{};const pct=p.total>0?Math.round(p.current/p.total*100):0;
        return<>
          <div style={{width:'80%',maxWidth:'300px',margin:'16px auto'}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:'4px'}}>
              <span style={{fontSize:'11px',color:'var(--t2)',fontFamily:"'JetBrains Mono'"}}>{p.current||0}/{p.total||'?'}</span>
              <span style={{fontSize:'11px',color:'var(--gn)',fontFamily:"'JetBrains Mono'"}}>{pct}%</span>
            </div>
            <div className="scan-prog"style={{height:'8px'}}><div className="scan-fill"style={{width:`${pct}%`}}/></div>
            {p.ok>0&&<p style={{fontSize:'10px',color:'var(--t3)',marginTop:'6px'}}>{p.ok} stocks analyzed ¬∑ {p.errors||0} skipped</p>}
          </div>
          {p.rate_limited&&<div style={{margin:'8px auto',padding:'8px 14px',background:'var(--rg)',borderRadius:'6px',fontSize:'11px',color:'var(--rd)',fontWeight:600,maxWidth:'340px'}}>‚ö† Rate limited by Angel One. Scan aborted. Wait ~1 min and retry.</div>}
        </>
      })()}
    </div></main></>;
  }

  const nB=(data.buy_signals||[]).length,nS=(data.sell_signals||[]).length,nP=(data.portfolio_holdings||[]).length;
  const ic=data.index_counts||{};
  const wlNames=Object.keys(watchlists);
  const scanDur=data.scan_duration_sec?`${(data.scan_duration_sec/60).toFixed(0)}m`:'';
  const curMode2=status?.scan_mode||'top500';
  const scanCount=status?.instruments_scan||nT;
  return<>
    <header className="hdr"><div className="hi">
      <div className="logo"><div className="lic">S</div><div className="lt">SignalScope</div></div>
      <div className="hr">
        <button className="bdg"onClick={toggleScanMode}style={{cursor:'pointer',border:curMode2==='full'?'1px solid var(--am)':'1px solid var(--bd)'}}>
          {curMode2==='top500'?'TOP 500':'ALL NSE'}<span style={{fontSize:'8px',opacity:.6,marginLeft:'2px'}}>{scanCount}</span>
        </button>
        <div className="bdg"><div className={`dot ${isSc?'w':'on'}`}/>{isSc?'SCANNING':'LIVE'}</div>
        <div className="bdg">{ago(data.last_scan)}{scanDur&&` ¬∑ ${scanDur}`}</div>
        <button className="btn btn-g"onClick={triggerScan}disabled={isSc}>{isSc?'‚Ä¶':'‚ñ∂'}</button>
      </div>
    </div></header>
    <main className="mn">
      {/* Stats */}
      {scanError&&<div style={{padding:'8px 14px',background:'var(--rg)',borderRadius:'8px',fontSize:'11px',color:'var(--rd)',fontWeight:600,marginBottom:'10px',display:'flex',justifyContent:'space-between',alignItems:'center'}}><span>{scanError}</span><button className="btn btn-sm"onClick={reconnect}style={{background:'var(--am)',border:'none',color:'#000'}}>üîå Reconnect</button></div>}
      <div className="sts">
        <div className="st"><div className="stl">All NSE</div><div className="stv"style={{color:'var(--bl)'}}>{nT.toLocaleString()}</div><div className="sts2">{(data.errors||[]).length} skipped</div></div>
        <div className="st"><div className="stl">Buy Signals</div><div className="stv"style={{color:'var(--gn)'}}>{nB}</div><div className="sts2">‚â•60/110</div></div>
        <div className="st"><div className="stl">Sell</div><div className="stv"style={{color:'var(--rd)'}}>{nS}</div><div className="sts2">‚â•3/6</div></div>
        <div className="st"><div className="stl">Portfolio</div><div className="stv"style={{color:'var(--pu)'}}>{nP}</div></div>
      </div>

      {/* Scanning progress bar */}
      {isSc&&(()=>{
        const p=progress||{};const pct=p.total>0?Math.round(p.current/p.total*100):0;
        return<div className="scan-bar"style={{flexDirection:'column',gap:'6px'}}>
          <div style={{display:'flex',alignItems:'center',gap:'8px',width:'100%'}}>
            <div className="sp"style={{width:16,height:16,margin:0,borderWidth:2,flexShrink:0}}/>
            <div style={{flex:1}}>
              <div style={{display:'flex',justifyContent:'space-between',marginBottom:'3px'}}>
                <span className="scan-txt">{p.current||0}/{p.total||'?'} stocks</span>
                <span className="scan-txt">{pct}%{p.ok>0&&` ¬∑ ${p.ok} analyzed`}{p.errors>0&&` ¬∑ ${p.errors} skipped`}</span>
              </div>
              <div className="scan-prog"><div className="scan-fill"style={{width:`${pct}%`}}/></div>
            </div>
          </div>
          {p.rate_limited&&<div style={{padding:'6px 10px',background:'var(--rg)',borderRadius:'5px',fontSize:'10px',color:'var(--rd)',fontWeight:600}}>‚ö† Rate limited by Angel One ‚Äî scan paused/aborted. Wait a minute and try again.</div>}
        </div>
      })()}

      {/* Index filter pills */}
      <div className="idx-row">
        {IDX_TABS.map(x=><button key={x.k}className={`idx-btn ${idxFilter===x.k?'a':''}`}data-idx={x.k}onClick={()=>{setIdxFilter(x.k);setActiveWL(null);setTab('all')}}>{x.l}<span className="idx-cnt">{x.k==='all'?nT:(ic[x.k]||0)}</span></button>)}
      </div>

      {/* Watchlist bar */}
      <div className="wl-bar">
        <span style={{fontSize:'10px',fontWeight:700,color:'var(--t3)',textTransform:'uppercase',letterSpacing:'.5px'}}>Watchlists:</span>
        {wlNames.map(wn=><div key={wn}className={`wl-chip ${idxFilter==='watchlist'&&activeWL===wn?'a':''}`}onClick={()=>{setIdxFilter('watchlist');setActiveWL(wn);setTab('all')}}>
          {wn}<span className="idx-cnt">{(watchlists[wn]||[]).length}</span>
          <span className="x"onClick={e=>{e.stopPropagation();if(confirm(`Delete "${wn}"?`))deleteWL(wn)}}>‚úï</span>
        </div>)}
        {addingWL?<form onSubmit={e=>{e.preventDefault();createWL(newWLName)}}style={{display:'flex',gap:'4px'}}><input ref={inputRef}className="wl-input"value={newWLName}onChange={e=>setNewWLName(e.target.value)}placeholder="Name..."onBlur={()=>setTimeout(()=>setAddingWL(false),200)}/><button type="submit"className="btn btn-sm btn-pu">Add</button></form>
        :<button className="wl-add-btn"onClick={()=>setAddingWL(true)}>+ New</button>}
      </div>

      {/* Signal tabs */}
      <div className="tabs">
        <button className={`tab ${tab==='all'?'a':''}`}onClick={()=>setTab('all')}>All<span className="tc tcb">{filteredCounts.all}</span></button>
        <button className={`tab ${tab==='buy'?'a':''}`}onClick={()=>setTab('buy')}>Buy<span className="tc tcg">{filteredCounts.buy}</span></button>
        <button className={`tab ${tab==='sell'?'a':''}`}onClick={()=>setTab('sell')}>Sell<span className="tc tcr">{filteredCounts.sell}</span></button>
        <button className={`tab ${tab==='port'?'a':''}`}onClick={()=>setTab('port')}>Portfolio<span className="tc tcb">{filteredCounts.port}</span></button>
      </div>

      <div className="srch"><input placeholder="Search any NSE stock..."value={search}onChange={e=>setSearch(e.target.value)}/></div>

      <div className="tc2">
        {stocks.length===0?<div className="empty"><div style={{fontSize:'32px',marginBottom:'8px'}}>{idxFilter==='watchlist'?'üìã':'üìä'}</div><div style={{fontSize:'13px'}}>{idxFilter==='watchlist'&&activeWL?`"${activeWL}" is empty. Click a stock ‚Üí add to watchlist.`:search?`No match for "${search}"`:'No stocks for this filter'}</div></div>
        :<div className="ts"><table>
          <thead><tr>
            <th onClick={()=>doSort('symbol')}>Stock</th>
            <th onClick={()=>doSort('price')}>Price</th>
            <th onClick={()=>doSort('buy_score')}>Buy</th>
            <th onClick={()=>doSort('sell_pct')}>Sell</th>
            <th onClick={()=>doSort('macd_slope')}>MACD ‚Üï</th>
            <th onClick={()=>doSort('rr_ratio')}>R:R</th>
            <th>Signal</th>
          </tr></thead>
          <tbody>{stocks.map(s=><tr key={s.symbol}onClick={()=>setSel(s)}style={{cursor:'pointer'}}>
            <td><div className="sn"><span className="sns">{s.name}</span>{s.in_portfolio&&<span className="pb">HELD</span>}<br/><span className="snn">{s.symbol}</span><ITags indices={s.indices}/></div></td>
            <td style={{fontWeight:600}}>‚Çπ{fmt(s.price)}</td>
            <td><span className={`score score-buy ${s.buy_score>=75?'strong':''}`}>{s.buy_score}</span></td>
            <td><span className="score score-sell">{s.sell_count}</span></td>
            <td><MACDSlope slope={s.macd_slope} phase={s.macd_phase} curve={s.macd_curve}/></td>
            <td><RR ratio={s.rr_ratio}/></td>
            <td>{s.buy_score>=75?<span className="sig sig-b">STRONG BUY</span>:s.buy_score>=60?<span className="sig sig-mb">MOD BUY</span>:s.is_sell&&s.in_portfolio?<span className="sig sig-s">SELL</span>:<span className="sig sig-h">HOLD</span>}</td>
          </tr>)}</tbody>
        </table></div>}
      </div>
    </main>
    {sel&&<Modal s={sel}onClose={()=>setSel(null)}watchlists={watchlists}onAddToWL={toggleInWL}/>}
  </>
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
